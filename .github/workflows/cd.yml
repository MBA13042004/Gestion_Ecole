name: PHP CI with MySQL

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

jobs:
  php-mysql-tests:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h localhost"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      # ğŸ§© Ã‰tape 1 : RÃ©cupÃ©ration du code
      - name: Checkout repository
        uses: actions/checkout@v3

      # ğŸ§© Ã‰tape 2 : Installation de PHP 8.1 avec extensions nÃ©cessaires
      - name: Setup PHP environment
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: mbstring, mysqli, pdo_mysql
          coverage: none

      # ğŸ§© Ã‰tape 3 : CrÃ©ation du fichier .env pour la connexion MySQL
      - name: Create environment file
        run: |
          echo "serveur=127.0.0.1" > Acces_BD/.env
          echo "utilisateur=root" >> Acces_BD/.env
          echo "password=root" >> Acces_BD/.env
          echo "db_name=gestion_ecole" >> Acces_BD/.env

      # ğŸ§© Ã‰tape 4 : Installation de dÃ©pendances Composer (si prÃ©sent)
      - name: Install dependencies
        run: composer install --no-interaction --prefer-dist || true

      # ğŸ§© Ã‰tape 5 : Attente du dÃ©marrage de MySQL
      - name: Wait for MySQL
        run: |
          echo "â³ Waiting for MySQL to be ready..."
          sleep 25

      # ğŸ§© Ã‰tape 6 : RÃ©initialisation et importation de la base
      - name: Reset and import database schema
        run: |
          echo "âš™ï¸ Resetting database..."
          mysql -h 127.0.0.1 -P 3306 -u root -proot -e "DROP DATABASE IF EXISTS gestion_ecole; CREATE DATABASE gestion_ecole;"
          echo "ğŸ“¦ Importing structure..."
          mysql -h 127.0.0.1 -P 3306 -u root -proot gestion_ecole < sql/database_setup.sql
          echo "ğŸ“Š Importing seed data..."
          mysql -h 127.0.0.1 -P 3306 -u root -proot gestion_ecole < sql/seed.sql

      # ğŸ§© Ã‰tape 7 : VÃ©rifier la connexion PHP <-> MySQL
      - name: Run PHP connection test
        run: php Acces_BD/test.php

      # ğŸ§© Ã‰tape 8 : (Optionnel) Lancer tous les tests PHP dans /tests
      - name: Run PHP unit tests (optional)
        if: ${{ hashFiles('tests/*.php') != '' }}
        run: |
          echo "ğŸ§ª Running PHP tests..."
          for test in tests/*.php; do
            echo "â¡ï¸  Running $test"
            php "$test"
          done

      # ğŸ§© Ã‰tape 9 : Validation finale
      - name: Workflow completed
        run: echo "âœ… CI pipeline finished successfully!"
