name: CI/CD - Gestion Ã‰cole

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]
  workflow_dispatch:

jobs:
  # Job 1: Tests et Validation
  test:
    name: Tests & Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout du code
        uses: actions/checkout@v4

      - name: ðŸ˜ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: mysqli, pdo_mysql, mbstring, xml, gd
          coverage: none

      - name: âœ… Validation de la syntaxe PHP
        run: |
          echo "VÃ©rification de la syntaxe PHP..."
          find . -name "*.php" -not -path "./vendor/*" -not -path "./.git/*" | while read file; do
            php -l "$file" || exit 1
          done
          echo "âœ… Aucune erreur de syntaxe dÃ©tectÃ©e"

      - name: ðŸ“Š VÃ©rification de la structure du projet
        run: |
          echo "VÃ©rification des rÃ©pertoires principaux..."
          [ -d "IHM" ] && echo "âœ… IHM" || exit 1
          [ -d "Acces_BD" ] && echo "âœ… Acces_BD" || exit 1
          [ -d "Gestion_Actions" ] && echo "âœ… Gestion_Actions" || exit 1
          [ -f "Index.php" ] && echo "âœ… Index.php" || exit 1
          [ -f "Acces_BD/sql/database_setup.sql" ] && echo "âœ… database_setup.sql" || echo "âš ï¸ database_setup.sql (optionnel)"
          echo "âœ… Structure du projet validÃ©e"

  # Job 2: Build Docker Image
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: ðŸ“¥ Checkout du code
        uses: actions/checkout@v4

      - name: ðŸ³ Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ” Login to Docker Hub
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ðŸ“ Extraire metadata Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.DOCKER_USERNAME }}/gestion-ecole
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: ðŸ—ï¸ Build et Push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

  # Job 3: Test Docker Compose
  docker-test:
    name: Test Docker Compose
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: ðŸ“¥ Checkout du code
        uses: actions/checkout@v4

      - name: ðŸ³ DÃ©marrage des conteneurs
        run: |
          docker compose up -d
          sleep 30  # Attendre que les services dÃ©marrent

      - name: ðŸ” VÃ©rification des conteneurs
        run: |
          docker compose ps
          docker compose logs web
          docker compose logs db

      - name: ðŸ§ª Test de santÃ© de l'application
        run: |
          curl -f http://localhost:8080 || exit 1
          echo "âœ… Application accessible"

      - name: ðŸ§¹ Nettoyage
        if: always()
        run: docker compose down -v

  # Job 4: DÃ©ploiement (optionnel - Ã  activer selon besoin)
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [test, build, docker-test]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: production
      url: https://votre-domaine.com
    
    steps:
      - name: ðŸ“¥ Checkout du code
        uses: actions/checkout@v4

      - name: ðŸš€ DÃ©ploiement
        run: |
          echo "ðŸš€ DÃ©ploiement vers la production..."
          echo "âš ï¸ Configurez votre mÃ©thode de dÃ©ploiement ici"
          # Exemple: SSH vers serveur, Docker Swarm, Kubernetes, etc.

      - name: âœ… Notification de succÃ¨s
        if: success()
        run: |
          echo "âœ… DÃ©ploiement rÃ©ussi!"

  # Job 5: Notification
  notify:
    name: Notification
    runs-on: ubuntu-latest
    needs: [test, build, docker-test]
    if: always()
    
    steps:
      - name: ðŸ“¢ RÃ©sumÃ© du workflow
        run: |
          echo "## ðŸ“Š RÃ©sumÃ© du CI/CD" >> $GITHUB_STEP_SUMMARY
          echo "- **Branche**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Auteur**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tests**: ${{ needs.test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build**: ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Docker Test**: ${{ needs.docker-test.result }}" >> $GITHUB_STEP_SUMMARY
